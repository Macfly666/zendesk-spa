<form id="mailingVipForm">
  <label>Sujet *</label>
  <input type="text" id="subject" required class="form-input" />

  <label>Contenu *</label>
  <div id="editor-container" class="editor"></div>

  <input type="hidden" id="content" name="content" />

  <label>Envoyer à *</label>
  <select id="audience" multiple required class="form-input">
    <option value="Client">Client</option>
    <option value="Vendeur">Vendeur</option>
    <option value="Média">Média</option>
    <option value="Éditeur">Éditeur</option>
    <option value="Test">Test</option>
  </select>

  <button type="submit" class="submit-button">Envoyer mailing VIP</button>
</form>

<!-- QuillJS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script>
  let quill;

  function initializeQuill() {
    quill = new Quill('#editor-container', {
      theme: 'snow',
      placeholder: 'Rédigez votre message...',
      modules: {
        toolbar: [
          ['bold', 'italic'],
          [{ 'list': 'ordered' }, { 'list': 'bullet' }],
          ['link'],
          ['clean']
        ]
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function () {
    initializeQuill();

    document.getElementById('mailingVipForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      if (!confirm("Confirmez-vous l'envoi du mailing VIP ?")) {
        return;
      }
      document.getElementById('content').value = quill.root.innerHTML;

      const selectedOptions = Array.from(document.getElementById('audience').selectedOptions).map(option => option.value);

      const body = {
        sujet: document.getElementById('subject').value,
        contenu: document.getElementById('content').value,
        audience: selectedOptions
      };

      try {
        const response = await fetch('https://n8n.ubiflow.net/webhook-test/mailing_vip', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        if (response.ok) {
          showToast("✅ Mailing VIP envoyé avec succès !");
          document.getElementById('mailingVipForm').reset();
          quill.setContents([]);
        } else {
          showToast("❌ Erreur : " + await response.text());
        }
      } catch (err) {
        showToast("❌ Problème de connexion.");
      }
    });
  });
</script>
