<form id="mailingVipForm">
  <label>Sujet *</label>
  <input type="text" id="subject" required />

  <label>Contenu *</label>
  <!-- ✅ Le conteneur Quill -->
  <div id="editor-container" style="height: 300px; background: #ffffff; margin-bottom: 20px; border: 1px solid #ccc;"></div>

  <!-- Champ caché pour récupérer le HTML -->
  <input type="hidden" id="content" name="content" />

  <label>Envoyer à *</label>
  <select id="audience" multiple required>
    <option value="Client">Client</option>
    <option value="Vendeur">Vendeur</option>
    <option value="Média">Média</option>
    <option value="Éditeur">Éditeur</option>
  </select>

  <button type="submit">Envoyer mailing VIP</button>
</form>

<!-- QuillJS CDN -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script>
  // Initialisation de Quill
  const quill = new Quill('#editor-container', {
    theme: 'snow',
    placeholder: 'Rédigez ici votre message...',
    modules: {
      toolbar: [
        [{ 'header': [1, 2, 3, false] }],
        ['bold', 'italic', 'underline', 'strike'],
        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
        ['link', 'image'],
        ['clean']
      ]
    }
  });

  // Gestion du submit
  document.getElementById('mailingVipForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    if (!confirm("Confirmez-vous l'envoi du mailing VIP ?")) {
      return;
    }
    // Injecte le contenu Quill dans l'input caché
    document.getElementById('content').value = quill.root.innerHTML;

    const selectedOptions = Array.from(document.getElementById('audience').selectedOptions).map(option => option.value);

    const body = {
      sujet: document.getElementById('subject').value,
      contenu: document.getElementById('content').value,
      audience: selectedOptions
    };

    try {
      const response = await fetch('https://n8n.ubiflow.net/webhook-test/mailing_vip', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (response.ok) {
        showToast("✅ Mailing VIP envoyé avec succès !");
        e.target.reset();
        quill.setContents([]);
      } else {
        showToast("❌ Erreur : " + await response.text());
      }
    } catch (err) {
      showToast("❌ Problème de connexion.");
    }
  });
</script>
